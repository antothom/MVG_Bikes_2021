---
title: "MVG Bikes 2021 - Bike Ride Analysis"
author: "Antoine Thomas"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r loading packages}
library(tidyverse)
library(ggmap)
```

```{r loading data, message=FALSE, warning=FALSE}
# Reading in raw data and formatting variable
df_rides_2021 <- read_csv2("MVG_Rad_Fahrten_2021.csv") %>%
  mutate(STARTLAT = as.character(STARTLAT),
         ENDLAT = as.character(ENDLAT),
         STARTLON = as.character(STARTLON),
         ENDLON = as.character(ENDLON)) %>%
  mutate(STARTLAT = gsub("(.{2})(.*)", "\\1.\\2", STARTLAT),
         ENDLAT = gsub("(.{2})(.*)", "\\1.\\2", ENDLAT),
         STARTLON = gsub("(.{2})(.*)", "\\1.\\2", STARTLON),
         ENDLON = gsub("(.{2})(.*)", "\\1.\\2", ENDLON)) %>%
   mutate(STARTLAT = as.numeric(STARTLAT),
         ENDLAT = as.numeric(ENDLAT),
         STARTLON = as.numeric(STARTLON),
         ENDLON = as.numeric(ENDLON)) 
```

```{r Bike Stations, message=FALSE, warning=FALSE}

# Filtering for all stations where rides started
start_stations <- df_rides_2021 %>%
  filter(!is.na(RENTAL_STATION_NAME)) %>%
  select(STARTLAT, STARTLON, RENTAL_STATION_NAME) %>%
  distinct() %>%
  rename(
    lat = STARTLAT,
    lon = STARTLON,
    station_name = RENTAL_STATION_NAME
    )

# Filtering for all stations where rides ended
end_stations <- df_rides_2021 %>%
  filter(!is.na(RETURN_STATION_NAME)) %>%
  select(ENDLAT, ENDLON, RETURN_STATION_NAME) %>%
  distinct() %>%
  rename(
    lat = ENDLAT,
    lon = ENDLON,
    station_name = RETURN_STATION_NAME
    )

# Merging all stations
all_stations <- end_stations %>%
  anti_join(start_stations, by = "station_name") %>%
  bind_rows(start_stations)


# Remove unnecessary data frames
rm(start_stations, end_stations)

# Creating bbox to plos
munich_bbox <- make_bbox(lon = all_stations$lon,
                         lat = all_stations$lat,
                         f = c(.26,.05))

# Loading map from osm
munich <- get_stamenmap(bbox = munich_bbox, zoom = 12, maptype = "terrain")

# Creating a plot with all MVG bike stations
ggmap(munich) +
  geom_point(aes(x = lon, y = lat), 
             data = all_stations, 
             color='black', 
             fill='#4562A2', 
             shape=21) +
  theme_bw() +
  theme(plot.title = element_text(face = "bold")) +
  labs(x = "Longitude",
       y = "Latitude",
       title = "MVG Bike Stations 2021",
       caption = "Map Data: OpenStreetMap")

# Removing unnecessary data structures
rm(munich, munich_bbox)

```

